<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE sqlMap SYSTEM "SqlMap.dtd">
<sqlMap>
  <update id="HU_RPT_CHANGE_EMP">
    select TB_1.*, TB_2.NV, TB_2.NV_SAL from
    (SELECT TB1.ID_C2,
    TB1.NAME_C2,
    TB1.NAME_C3,
    TB1.NAME_C4,
    TB1.ORG_LINK,
    TB1.ORG_LINK_NAME,
    SUM(CASE
    WHEN TB1.FULLNAME_VN IS NOT NULL THEN
    1
    ELSE
    0
    END) TONG_NV,
    SUM(CASE
    WHEN TB1.FULLNAME_VN IS NOT NULL AND TB1.CONTRACTUAL_SAL IS NOT NULL THEN
    TB1.CONTRACTUAL_SAL
    ELSE
    0
    END) TONG_NV_SAL,
    SUM(CASE
    WHEN
    (TB1.FULLNAME_VN IS NOT NULL) AND
    ((TB1.ORG_PREV_ID IS NULL) OR
    (TB1.ORG_LINK = TB1.ORG_ID AND TB1.ORG_LINK &lt;> TB1.ORG_PREV_ID)) THEN
    1
    ELSE
    0
    END) TD,

    ---------------------
    SUM(CASE
    WHEN
    (TB1.FULLNAME_VN IS NOT NULL ) AND
    (    (TB1.ORG_PREV_ID IS NULL) OR
    (TB1.ORG_LINK = TB1.ORG_ID AND TB1.ORG_LINK &lt;> TB1.ORG_PREV_ID) ) THEN
    NVL(TB1.CONTRACTUAL_SAL,0)
    ELSE
    0
    END) TD_SAL
    -------------------
    FROM (SELECT W.CONTRACTUAL_SAL,
    W.ORG_ID,
    W.EFFECT_DATE,
    W1.ORG_ID ORG_PREV_ID,
    EMP.ID,
    EMP.FULLNAME_VN,
    EMP.JOIN_DATE,
    EMP.TER_EFFECT_DATE,
    O.NAME_C1,
    O.ID_C2,
    O.NAME_C2,
    O.NAME_C3,
    O.NAME_C4,
    O.ORG_LINK,
    O.ORG_LINK_NAME
    FROM (SELECT NAME_C1,
    NAME_C2,
    NAME_C3,
    NAME_C4,
    ID_C1,
    ID_C2,
    ID_C3,
    ID_C4,
    CASE
    WHEN ID_C4 IS NOT NULL THEN
    ID_C4
    WHEN ID_C3 IS NOT NULL THEN
    ID_C3
    WHEN ID_C2 IS NOT NULL THEN
    ID_C2
    WHEN ID_C1 IS NOT NULL THEN
    ID_C1
    END ORG_LINK,
    CASE
    WHEN ID_C4 IS NOT NULL THEN
    NAME_C4
    WHEN ID_C3 IS NOT NULL THEN
    NAME_C3
    WHEN ID_C2 IS NOT NULL THEN
    NAME_C2
    WHEN ID_C1 IS NOT NULL THEN
    NAME_C1
    END ORG_LINK_NAME,
    ID,
    DESCRIPTION_PATH
    FROM (SELECT SUBSTR(REGEXP_SUBSTR(ORG_NAME, '![^!]*', 1, 1),
    2) AS NAME_C1,
    SUBSTR(REGEXP_SUBSTR(ORG_NAME, '![^!]*', 1, 2),
    2) AS NAME_C2,
    SUBSTR(REGEXP_SUBSTR(ORG_NAME, '![^!]*', 1, 3),
    2) AS NAME_C3,
    SUBSTR(REGEXP_SUBSTR(ORG_NAME, '![^!]*', 1, 4),
    2) AS NAME_C4,
    ACTFLG,
    SUBSTR(REGEXP_SUBSTR(IDS, '![^!]*', 1, 1), 2) AS ID_C1,
    SUBSTR(REGEXP_SUBSTR(IDS, '![^!]*', 1, 2), 2) AS ID_C2,
    SUBSTR(REGEXP_SUBSTR(IDS, '![^!]*', 1, 3), 2) AS ID_C3,
    SUBSTR(REGEXP_SUBSTR(IDS, '![^!]*', 1, 4), 2) AS ID_C4,
    DESCRIPTION_PATH,
    ID
    FROM (SELECT O.ID,
    O.DESCRIPTION_PATH, O.Actflg,
    SYS_CONNECT_BY_PATH(O.NAME_VN, '!') ORG_NAME,
    SYS_CONNECT_BY_PATH(O.ID, '!') IDS
    FROM HU_ORGANIZATION O
    START WITH O.PARENT_ID IS NULL
    CONNECT BY PRIOR O.ID = O.PARENT_ID)) O
    WHERE NAME_C2 IS NOT NULL AND O.Actflg = 'A'
    <isPropertyAvailable property ="ORGLISTID">
      <isNotEmpty property="ORGLISTID">
        AND ID IN ($ORGLISTID$)
      </isNotEmpty>
    </isPropertyAvailable>
    ORDER BY O.DESCRIPTION_PATH) O
    LEFT JOIN (SELECT *
    FROM (SELECT T.*,
    ROW_NUMBER() OVER(PARTITION BY T.EMPLOYEE_ID ORDER BY T.EFFECT_DATE DESC, T.CREATED_DATE DESC) STT
    FROM HU_WORKING T
    WHERE T.EFFECT_DATE &lt;=
    <isNotEmpty property="END_DATE">
      TRUNC(#END_DATE#)
    </isNotEmpty>
    AND ((T.EXPIRE_DATE IS NULL) OR
    (T.EXPIRE_DATE >=
    <isNotEmpty property="END_DATE">
      TRUNC(#END_DATE#)
    </isNotEmpty>
    ))
    AND T.STATUS = 447)
    WHERE STT = 1) W
    ON O.ID = W.ORG_ID
    LEFT JOIN (SELECT *
    FROM (SELECT T.*,
    ROW_NUMBER() OVER(PARTITION BY T.EMPLOYEE_ID ORDER BY T.EFFECT_DATE DESC, T.CREATED_DATE DESC) STT
    FROM HU_WORKING T
    WHERE T.EFFECT_DATE &lt;=
    <isNotEmpty property="END_DATE_LAST_MONTH">
      TRUNC(#END_DATE_LAST_MONTH#)
    </isNotEmpty>

    AND ((T.EXPIRE_DATE IS NULL) OR
    (T.EXPIRE_DATE >=
    <isNotEmpty property="END_DATE_LAST_MONTH">
      TRUNC(#END_DATE_LAST_MONTH#)
    </isNotEmpty>
    ))
    AND T.STATUS = 447)
    WHERE STT = 1) W1
    ON W.EMPLOYEE_ID = W1.EMPLOYEE_ID

    LEFT JOIN HU_EMPLOYEE EMP
    ON W.EMPLOYEE_ID = EMP.ID
    AND (EMP.JOIN_DATE IS NOT NULL OR
    (EMP.TER_EFFECT_DATE IS NOT NULL))) TB1
    GROUP BY TB1.ID_C2,
    TB1.NAME_C2,
    TB1.NAME_C3,
    TB1.NAME_C4,
    TB1.ORG_LINK,
    TB1.ORG_LINK_NAME
    ORDER BY TB1.ID_C2, TB1.NAME_C2, TB1.NAME_C3 DESC, TB1.NAME_C4 DESC
    ) TB_1
    -----------------
    JOIN
    (SELECT TB1.ID_C2,
    TB1.NAME_C2,
    TB1.NAME_C3,
    TB1.NAME_C4,
    TB1.ORG_LINK,
    TB1.ORG_LINK_NAME,
    SUM(CASE
    WHEN TB1.FULLNAME_VN IS NOT NULL THEN
    1
    ELSE
    0
    END) TONG_NV,
    SUM(NVL(TB1.CONTRACTUAL_SAL, 0)) TONG_NV_SAL,
    SUM(CASE
    WHEN (TB1.TER_EFFECT_DATE IS NOT NULL AND
    TB1.TER_EFFECT_DATE >=
    <isNotEmpty property="START_DATE_LAST_MONTH">
      TRUNC(#START_DATE_LAST_MONTH#)
    </isNotEmpty>
    AND
    TB1.TER_EFFECT_DATE &lt;=
    <isNotEmpty property="END_DATE_LAST_MONTH">
      TRUNC(#END_DATE_LAST_MONTH#)
    </isNotEmpty>
    ) OR
    (TB1.ORG_LINK = TB1.ORG_ID AND TB1.ORG_LINK &lt;> TB1.ORG_NEXT_ID) THEN
    1
    ELSE
    0
    END) NV,
    SUM(CASE
    WHEN (TB1.TER_EFFECT_DATE IS NOT NULL AND
    TB1.TER_EFFECT_DATE >=
    <isNotEmpty property="START_DATE_LAST_MONTH">
      TRUNC(#START_DATE_LAST_MONTH#)
    </isNotEmpty>
    AND
    TB1.TER_EFFECT_DATE &lt;=
    <isNotEmpty property="END_DATE_LAST_MONTH">
      TRUNC(#END_DATE_LAST_MONTH#)
    </isNotEmpty>
    ) OR
    (TB1.ORG_LINK = TB1.ORG_ID AND TB1.ORG_LINK &lt;> TB1.ORG_NEXT_ID) THEN
    TB1.CONTRACTUAL_SAL
    ELSE
    0
    END) NV_SAL
    FROM (SELECT W.CONTRACTUAL_SAL,
    W.ORG_ID,
    W.EFFECT_DATE,
    W1.ORG_ID ORG_NEXT_ID,
    EMP.ID,
    EMP.FULLNAME_VN,
    EMP.JOIN_DATE,
    EMP.TER_EFFECT_DATE,
    O.NAME_C1,
    O.ID_C2,
    O.NAME_C2,
    O.NAME_C3,
    O.NAME_C4,
    O.ORG_LINK,
    O.ORG_LINK_NAME
    FROM (SELECT NAME_C1,
    NAME_C2,
    NAME_C3,
    NAME_C4,
    ID_C1,
    ID_C2,
    ID_C3,
    ID_C4,
    CASE
    WHEN ID_C4 IS NOT NULL THEN
    ID_C4
    WHEN ID_C3 IS NOT NULL THEN
    ID_C3
    WHEN ID_C2 IS NOT NULL THEN
    ID_C2
    WHEN ID_C1 IS NOT NULL THEN
    ID_C1
    END ORG_LINK,
    CASE
    WHEN ID_C4 IS NOT NULL THEN
    NAME_C4
    WHEN ID_C3 IS NOT NULL THEN
    NAME_C3
    WHEN ID_C2 IS NOT NULL THEN
    NAME_C2
    WHEN ID_C1 IS NOT NULL THEN
    NAME_C1
    END ORG_LINK_NAME,
    ID,
    DESCRIPTION_PATH
    FROM (SELECT SUBSTR(REGEXP_SUBSTR(ORG_NAME, '![^!]*', 1, 1),
    2) AS NAME_C1,
    SUBSTR(REGEXP_SUBSTR(ORG_NAME, '![^!]*', 1, 2),
    2) AS NAME_C2,
    SUBSTR(REGEXP_SUBSTR(ORG_NAME, '![^!]*', 1, 3),
    2) AS NAME_C3,
    SUBSTR(REGEXP_SUBSTR(ORG_NAME, '![^!]*', 1, 4),
    2) AS NAME_C4,
    ACTFLG,
    SUBSTR(REGEXP_SUBSTR(IDS, '![^!]*', 1, 1), 2) AS ID_C1,
    SUBSTR(REGEXP_SUBSTR(IDS, '![^!]*', 1, 2), 2) AS ID_C2,
    SUBSTR(REGEXP_SUBSTR(IDS, '![^!]*', 1, 3), 2) AS ID_C3,
    SUBSTR(REGEXP_SUBSTR(IDS, '![^!]*', 1, 4), 2) AS ID_C4,
    DESCRIPTION_PATH,
    ID
    FROM (SELECT O.ID,
    O.DESCRIPTION_PATH, O.Actflg,
    SYS_CONNECT_BY_PATH(O.NAME_VN, '!') ORG_NAME,
    SYS_CONNECT_BY_PATH(O.ID, '!') IDS
    FROM HU_ORGANIZATION O
    START WITH O.PARENT_ID IS NULL
    CONNECT BY PRIOR O.ID = O.PARENT_ID)) O
    WHERE NAME_C2 IS NOT NULL AND O.Actflg = 'A'
    <isPropertyAvailable property ="ORGLISTID">
      <isNotEmpty property="ORGLISTID">
        AND ID IN ($ORGLISTID$)
      </isNotEmpty>
    </isPropertyAvailable>
    ORDER BY O.DESCRIPTION_PATH) O
    LEFT JOIN (SELECT *
    FROM (SELECT T.*,
    ROW_NUMBER() OVER(PARTITION BY T.EMPLOYEE_ID ORDER BY T.EFFECT_DATE DESC, T.CREATED_DATE DESC) STT
    FROM HU_WORKING T
    WHERE T.EFFECT_DATE &lt;=
    <isNotEmpty property="END_DATE_LAST_MONTH">
      TRUNC(#END_DATE_LAST_MONTH#)
    </isNotEmpty>

    AND ((T.EXPIRE_DATE IS NULL) OR
    (T.EXPIRE_DATE >=
    <isNotEmpty property="END_DATE_LAST_MONTH">
      TRUNC(#END_DATE_LAST_MONTH#)
    </isNotEmpty>
    ))
    AND T.STATUS = 447)
    WHERE STT = 1) W
    ON O.ID = W.ORG_ID

    LEFT JOIN (SELECT *
    FROM (SELECT T.*,
    ROW_NUMBER() OVER(PARTITION BY T.EMPLOYEE_ID ORDER BY T.EFFECT_DATE DESC, T.CREATED_DATE DESC) STT
    FROM HU_WORKING T
    WHERE T.EFFECT_DATE &lt;=
    <isNotEmpty property="END_DATE">
      TRUNC(#END_DATE#)
    </isNotEmpty>
    AND ((T.EXPIRE_DATE IS NULL) OR
    (T.EXPIRE_DATE >=
    <isNotEmpty property="END_DATE">
      TRUNC(#END_DATE#)
    </isNotEmpty>
    ))
    AND T.STATUS = 447)
    WHERE STT = 1) W1
    ON W.EMPLOYEE_ID = W1.EMPLOYEE_ID

    LEFT JOIN HU_EMPLOYEE EMP
    ON W.EMPLOYEE_ID = EMP.ID
    AND (EMP.JOIN_DATE IS NOT NULL OR
    (EMP.TER_EFFECT_DATE IS NOT NULL))) TB1
    GROUP BY TB1.ID_C2,
    TB1.NAME_C2,
    TB1.NAME_C3,
    TB1.NAME_C4,
    TB1.ORG_LINK,
    TB1.ORG_LINK_NAME
    ORDER BY TB1.ID_C2, TB1.NAME_C2, TB1.NAME_C3 DESC, TB1.NAME_C4 DESC
    ) TB_2

    ON TB_1.ORG_LINK = TB_2.ORG_LINK
  </update>
</sqlMap>